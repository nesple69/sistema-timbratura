<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Timbratura - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" id="appManifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Timbratura">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            min-height: 600px;
        }
        
        .logo {
            font-size: 32px;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 40px;
        }
        
        .orario {
            font-size: 48px;
            font-weight: 300;
            color: #333;
            margin: 10px 0;
        }
        
        .data {
            color: #666;
            margin-bottom: 40px;
        }
        
        .dipendenti-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .dipendente-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 25px 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .dipendente-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            background: #5a6fd8;
        }
        
        .dipendente-btn:active {
            transform: translateY(0);
        }
        
        .admin-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            z-index: 100;
        }
        
        .admin-btn:hover {
            background: #34495e;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        
        .hidden {
            display: none;
        }
        
        /* STILI APP DIPENDENTI */
        .app-container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .app-header {
            background: #667eea;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .timbratura-section {
            padding: 30px;
            text-align: center;
        }
        
        .btn-timbratura {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-timbratura:active {
            transform: scale(0.98);
        }
        
        .btn-entrata {
            background: #27ae60;
            color: white;
        }
        
        .btn-uscita {
            background: #e74c3c;
            color: white;
        }
        
        .riepilogo {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
        }
        
        .riepilogo-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        /* STILI ADMIN */
        .admin-container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-nav {
            background: #34495e;
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: transparent;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-btn.active {
            background: #667eea;
        }
        
        .admin-content {
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .btn-backup {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .form-row > * {
            flex: 1;
        }
        
        .timbratura-actions {
            display: flex;
            gap: 5px;
        }
        
        /* NOTIFICHE */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: #27ae60;
        }
        
        .notification.error {
            background: #e74c3c;
        }
        
        .notification.info {
            background: #3498db;
        }
        
        /* STATISTICS CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        /* BACKUP SECTION */
        .backup-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .backup-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .backup-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            color: #1976d2;
        }
        
        .backup-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .backup-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .backup-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        /* INSTALL APP SECTION */
        .install-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .install-step {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .step-description {
            color: #666;
            font-size: 14px;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .dipendenti-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .admin-nav {
                flex-direction: column;
            }
            
            .nav-btn {
                width: 100%;
                text-align: left;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .timbratura-actions {
                flex-direction: column;
            }
            
            .admin-btn {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .backup-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- NOTIFICATION SYSTEM -->
    <div id="notification" class="notification"></div>
    
    <!-- DASHBOARD PRINCIPALE - SOLO DIPENDENTI -->
    <div class="container" id="dashboardPage">
        <div class="dashboard-card">
            <div class="logo">
                <i class="fas fa-clock"></i>
                TIMBRATURA
            </div>
            <div class="subtitle">Sistema Gestione Presenze</div>
            
            <div class="orario" id="dashboardOrario">00:00:00</div>
            <div class="data" id="dashboardData">Lunedì 1 Gennaio 2024</div>
            
            <!-- Statistiche -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Dipendenti Totali</div>
                    <div class="stat-value" id="totalDipendenti">6</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Timbrature Oggi</div>
                    <div class="stat-value" id="timbratureOggi">12</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Presenti Oggi</div>
                    <div class="stat-value" id="presentiOggi">4</div>
                </div>
            </div>
            
            <h3 style="margin-bottom: 20px; color: #333;">Seleziona Dipendente</h3>
            
            <div class="dipendenti-grid" id="dipendentiGrid">
                <!-- Pulsanti dipendenti verranno generati dinamicamente -->
            </div>
            
            <div style="color: #666; font-size: 14px;">
                <i class="fas fa-info-circle"></i> Clicca sul tuo nome e inserisci la password per timbrare
            </div>
        </div>
        
        <!-- PULSANTE ADMIN -->
        <button class="admin-btn" onclick="showAdminLogin()">
            <i class="fas fa-cog"></i>
            <span>Admin</span>
        </button>
    </div>

    <!-- MODAL LOGIN DIPENDENTE -->
    <div class="modal" id="modalDipendenteLogin">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Accesso Dipendente</h3>
                <button class="close-modal" onclick="hideModal('modalDipendenteLogin')">&times;</button>
            </div>
            <div class="dipendente-nome" id="dipendenteLoginNome" style="font-size: 24px; margin-bottom: 20px; color: #333;">Nome Dipendente</div>
            <input type="password" class="password-input" id="dipendentePassword" placeholder="Inserisci password" autocomplete="off" style="width: 100%; padding: 15px; border: 2px solid #e1e1e1; border-radius: 10px; font-size: 18px; text-align: center; margin-bottom: 20px;">
            <button class="btn-primary" onclick="loginDipendente()" style="width: 100%; padding: 15px; font-size: 18px;">
                <i class="fas fa-sign-in-alt"></i> ACCEDI
            </button>
            <button class="btn-secondary" onclick="hideModal('modalDipendenteLogin')" style="width: 100%; padding: 15px; background: transparent; color: #666; border: 2px solid #e1e1e1; border-radius: 10px; font-size: 18px; margin-top: 10px;">
                ANNULLA
            </button>
        </div>
    </div>

    <!-- MODAL LOGIN ADMIN -->
    <div class="modal" id="modalAdminLogin">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-shield"></i> Accesso Amministratore</h3>
                <button class="close-modal" onclick="hideModal('modalAdminLogin')">&times;</button>
            </div>
            <div style="text-align: left;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">Password Amministratore</label>
                    <input type="password" id="adminPassword" placeholder="Inserisci password admin" style="width: 100%; padding: 15px; border: 2px solid #e1e1e1; border-radius: 10px; font-size: 16px;">
                </div>
                <button class="btn-primary" onclick="loginAdmin()" style="width: 100%; padding: 15px; font-size: 18px;">
                    <i class="fas fa-sign-in-alt"></i> ACCEDI COME ADMIN
                </button>
            </div>
        </div>
    </div>

    <!-- PANNELLO AMMINISTRATORE -->
    <div class="admin-container hidden" id="adminApp">
        <div class="admin-header">
            <div>
                <div style="font-size: 24px;"><i class="fas fa-tools"></i> PANNELLO AMMINISTRATORE</div>
                <div style="font-size: 14px; opacity: 0.8;">Gestione completa sistema</div>
            </div>
            <button class="logout-btn" onclick="logoutAdmin()">
                <i class="fas fa-sign-out-alt"></i> LOGOUT
            </button>
        </div>
        
        <div class="admin-nav">
            <button class="nav-btn active" onclick="showAdminSection('install')">
                <i class="fas fa-mobile-alt"></i> App Tablet
            </button>
            <button class="nav-btn" onclick="showAdminSection('dipendenti')">
                <i class="fas fa-users"></i> Dipendenti
            </button>
            <button class="nav-btn" onclick="showAdminSection('timbrature')">
                <i class="fas fa-clock"></i> Timbrature
            </button>
            <button class="nav-btn" onclick="showAdminSection('report')">
                <i class="fas fa-chart-bar"></i> Report
            </button>
            <button class="nav-btn" onclick="showAdminSection('backup')">
                <i class="fas fa-download"></i> Backup
            </button>
        </div>
        
        <div class="admin-content">
            <!-- SEZIONE INSTALLA APP TABLET -->
            <div id="sectionInstall" class="section active">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-mobile-alt"></i> Installa App sul Tablet</h3>
                        <div style="color: #666; font-size: 14px;">
                            Trasforma questa web app in un'app per tablet
                        </div>
                    </div>
                    
                    <div class="backup-section">
                        <h4><i class="fas fa-download"></i> Installa App</h4>
                        <p>Aggiungi questa applicazione alla schermata home del tablet</p>
                        
                        <div id="installButtonContainer">
                            <!-- Il pulsante verrà mostrato qui -->
                        </div>
                        
                        <div class="install-steps">
                            <div class="install-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <div class="step-title">Apri sul Tablet</div>
                                    <div class="step-description">Apri questa pagina sul tablet usando Chrome o Safari</div>
                                </div>
                            </div>
                            
                            <div class="install-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <div class="step-title">Tocca il Pulsante</div>
                                    <div class="step-description">Tocca "Installa App sul Tablet" qui sopra</div>
                                </div>
                            </div>
                            
                            <div class="install-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <div class="step-title">Conferma Installazione</div>
                                    <div class="step-description">Tocca "Installa" o "Aggiungi alla home"</div>
                                </div>
                            </div>
                            
                            <div class="install-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <div class="step-title">Usa l'App</div>
                                    <div class="step-description">Trova l'icona "Timbratura" sulla home del tablet</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="backup-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Dopo l'installazione:</strong> L'app apparirà come un'icona sulla home del tablet 
                        e si aprirà a schermo intero come un'app nativa.
                    </div>
                </div>
            </div>

            <!-- SEZIONE GESTIONE DIPENDENTI -->
            <div id="sectionDipendenti" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-users"></i> Gestione Dipendenti</h3>
                        <button class="btn-primary" onclick="showModal('modalAggiungiDipendente')">
                            <i class="fas fa-plus"></i> Nuovo Dipendente
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Username</th>
                                <th>Password</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaDipendenti">
                            <!-- Popolata dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- SEZIONE GESTIONE TIMBRATURE -->
            <div id="sectionTimbrature" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-clock"></i> Gestione Timbrature</h3>
                        <div class="form-row">
                            <select id="filtroDipendente" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Tutti i dipendenti</option>
                            </select>
                            <input type="date" id="filtroData" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <button class="btn-primary" onclick="filtraTimbrature()">
                                <i class="fas fa-filter"></i> Filtra
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Dipendente</th>
                                <th>Data</th>
                                <th>Entrata</th>
                                <th>Uscita</th>
                                <th>Ore Lavorate</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tabellaTimbrature">
                            <!-- Popolata dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- SEZIONE REPORT -->
            <div id="sectionReport" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-bar"></i> Report e Statistiche</h3>
                        <div class="form-row">
                            <select id="reportDipendente" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Tutti i dipendenti</option>
                            </select>
                            <input type="month" id="reportMese" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <button class="btn-primary" onclick="generaReport()">
                                <i class="fas fa-chart-line"></i> Genera Report
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Ore Totali</div>
                            <div class="stat-value" id="reportOreTotali">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Giorni Lavorati</div>
                            <div class="stat-value" id="reportGiorni">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Media Ore/Giorno</div>
                            <div class="stat-value" id="reportMedia">0</div>
                        </div>
                    </div>
                    
                    <div id="reportDettaglio" style="margin-top: 20px;">
                        <!-- Dettaglio report -->
                    </div>
                </div>
            </div>
            
            <!-- SEZIONE BACKUP -->
            <div id="sectionBackup" class="section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-download"></i> Backup e Ripristino</h3>
                    </div>
                    
                    <div class="backup-section">
                        <h4><i class="fas fa-file-export"></i> Esporta Dati</h4>
                        <p>Scarica un backup completo dei dati del sistema</p>
                        
                        <div class="backup-options">
                            <button class="btn-backup" onclick="esportaDati('excel')">
                                <i class="fas fa-file-excel"></i> Esporta in Excel
                            </button>
                            <button class="btn-backup" onclick="esportaDati('json')">
                                <i class="fas fa-file-code"></i> Esporta in JSON
                            </button>
                        </div>
                        
                        <div class="backup-info">
                            <i class="fas fa-info-circle"></i> 
                            Il backup includerà tutti i dipendenti e le timbrature registrate.
                        </div>
                    </div>
                    
                    <div class="backup-section" style="margin-top: 20px;">
                        <h4><i class="fas fa-file-import"></i> Ripristina Dati</h4>
                        <p>Carica un backup precedente per ripristinare i dati</p>
                        
                        <div class="backup-options">
                            <input type="file" id="fileBackup" accept=".xlsx,.json" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <button class="btn-primary" onclick="ripristinaDati()">
                                <i class="fas fa-upload"></i> Carica Backup
                            </button>
                        </div>
                        
                        <div class="backup-info">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>Attenzione:</strong> Il ripristino sovrascriverà i dati attuali.
                        </div>
                    </div>
                    
                    <div id="backupStatus" class="backup-status" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AGGIUNGI DIPENDENTE -->
    <div class="modal" id="modalAggiungiDipendente">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Aggiungi Dipendente</h3>
                <button class="close-modal" onclick="hideModal('modalAggiungiDipendente')">&times;</button>
            </div>
            <div style="text-align: left;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">Nome Completo</label>
                    <input type="text" id="nuovoNome" placeholder="Nome e Cognome" style="width: 100%; padding: 12px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 16px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">Username</label>
                    <input type="text" id="nuovoUsername" placeholder="Username univoco" style="width: 100%; padding: 12px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 16px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">Password</label>
                    <input type="password" id="nuovaPassword" placeholder="Password per accesso" style="width: 100%; padding: 12px; border: 2px solid #e1e1e1; border-radius: 8px; font-size: 16px;">
                </div>
                <button class="btn-primary" onclick="aggiungiDipendente()" style="width: 100%; padding: 15px; font-size: 18px;">
                    <i class="fas fa-save"></i> SALVA DIPENDENTE
                </button>
            </div>
        </div>
    </div>

    <script>
        // DATI
        let dipendenti = [
            { id: 1, nome: "Mario Rossi", username: "mrossi", password: "1234" },
            { id: 2, nome: "Laura Bianchi", username: "lbianchi", password: "1234" },
            { id: 3, nome: "Giuseppe Verdi", username: "gverdi", password: "1234" },
            { id: 4, nome: "Anna Neri", username: "aneri", password: "1234" },
            { id: 5, nome: "Paolo Gialli", username: "pgialli", password: "1234" },
            { id: 6, nome: "Francesca Blu", username: "fblu", password: "1234" }
        ];
        
        let timbrature = [
            { id: 1, dipendenteId: 1, data: "2024-01-15", entrata: "08:00", uscita: "17:00" },
            { id: 2, dipendenteId: 2, data: "2024-01-15", entrata: "08:30", uscita: "17:30" },
            { id: 3, dipendenteId: 3, data: "2024-01-15", entrata: "09:00", uscita: "18:00" },
            { id: 4, dipendenteId: 1, data: "2024-01-16", entrata: "08:15", uscita: "17:15" },
            { id: 5, dipendenteId: 2, data: "2024-01-16", entrata: "08:45", uscita: "17:45" }
        ];
        
        const adminPassword = "admin123";
        let selectedDipendenteId = null;
        let deferredPrompt = null;

        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            updateClock();
            setInterval(updateClock, 1000);
            caricaDipendentiDashboard();
            gestisciInstallazionePWA();
            aggiornaStatisticheDashboard();
        });

        // FUNZIONI PRINCIPALI
        function caricaDipendentiDashboard() {
            const grid = document.getElementById('dipendentiGrid');
            grid.innerHTML = '';
            
            dipendenti.forEach(dipendente => {
                const button = document.createElement('button');
                button.className = 'dipendente-btn';
                button.innerHTML = `<i class="fas fa-user"></i> ${dipendente.nome}`;
                button.onclick = () => showDipendenteLogin(dipendente.id);
                grid.appendChild(button);
            });
        }
        
        function showDipendenteLogin(dipendenteId) {
            const dipendente = dipendenti.find(d => d.id === dipendenteId);
            selectedDipendenteId = dipendenteId;
            document.getElementById('dipendenteLoginNome').textContent = dipendente.nome;
            document.getElementById('dipendentePassword').value = '';
            showModal('modalDipendenteLogin');
        }
        
        function loginDipendente() {
            const password = document.getElementById('dipendentePassword').value;
            const dipendente = dipendenti.find(d => d.id === selectedDipendenteId);
            
            if (dipendente && dipendente.password === password) {
                const now = new Date();
                const data = now.toISOString().split('T')[0];
                const orario = now.toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'});
                
                // Verifica se esiste già una timbratura per oggi
                const timbraturaOggi = timbrature.find(t => 
                    t.dipendenteId === dipendente.id && t.data === data
                );
                
                if (timbraturaOggi && !timbraturaOggi.uscita) {
                    // Registra uscita
                    timbraturaOggi.uscita = orario;
                    showNotification(`✅ Uscita registrata per ${dipendente.nome} - ${orario}`, 'success');
                } else if (!timbraturaOggi) {
                    // Registra entrata
                    const nuovaTimbratura = {
                        id: timbrature.length + 1,
                        dipendenteId: dipendente.id,
                        data: data,
                        entrata: orario,
                        uscita: null
                    };
                    timbrature.push(nuovaTimbratura);
                    showNotification(`✅ Entrata registrata per ${dipendente.nome} - ${orario}`, 'success');
                } else {
                    showNotification(`⚠️ Timbratura già completata per oggi`, 'info');
                }
                
                hideModal('modalDipendenteLogin');
                aggiornaStatisticheDashboard();
            } else {
                showNotification('❌ Password errata!', 'error');
            }
        }

        function showAdminLogin() {
            document.getElementById('adminPassword').value = '';
            showModal('modalAdminLogin');
        }

        function loginAdmin() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === adminPassword) {
                document.getElementById('dashboardPage').classList.add('hidden');
                document.getElementById('adminApp').classList.remove('hidden');
                hideModal('modalAdminLogin');
                caricaDipendentiAdmin();
                caricaTimbratureAdmin();
                caricaFiltriDipendenti();
                aggiornaStatisticheDashboard();
            } else {
                showNotification('❌ Password admin errata!', 'error');
            }
        }

        function logoutAdmin() {
            document.getElementById('adminApp').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
        }

        // PWA INSTALLAZIONE
        function gestisciInstallazionePWA() {
            const container = document.getElementById('installButtonContainer');
            
            if (window.matchMedia('(display-mode: standalone)').matches) {
                container.innerHTML = `
                    <div class="backup-success">
                        <i class="fas fa-check-circle"></i> App già installata sul tablet!
                    </div>
                `;
                return;
            }
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                container.innerHTML = `
                    <button class="btn-backup" onclick="installaApp()">
                        <i class="fas fa-download"></i> Installa App sul Tablet
                    </button>
                `;
            });
            
            setTimeout(() => {
                if (!deferredPrompt) {
                    container.innerHTML = `
                        <div class="backup-info">
                            <i class="fas fa-info-circle"></i> 
                            Apri questa pagina sul tablet e segui le istruzioni manuali.
                        </div>
                    `;
                }
            }, 1000);
        }

        function installaApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showNotification('App installata con successo!', 'success');
                    }
                    deferredPrompt = null;
                });
            }
        }

        // FUNZIONI ADMIN
        function showAdminSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('section' + section.charAt(0).toUpperCase() + section.slice(1)).classList.add('active');
            event.target.classList.add('active');
            
            // Carica dati specifici per sezione
            if (section === 'timbrature') {
                caricaTimbratureAdmin();
            } else if (section === 'report') {
                caricaFiltriReport();
            }
        }

        function caricaDipendentiAdmin() {
            const tbody = document.getElementById('tabellaDipendenti');
            tbody.innerHTML = '';
            
            dipendenti.forEach(dipendente => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dipendente.nome}</td>
                    <td>${dipendente.username}</td>
                    <td>${'*'.repeat(dipendente.password.length)}</td>
                    <td>
                        <button class="btn-primary" onclick="modificaDipendente(${dipendente.id})">
                            <i class="fas fa-edit"></i> Modifica
                        </button>
                        <button class="btn-danger" onclick="eliminaDipendente(${dipendente.id})">
                            <i class="fas fa-trash"></i> Elimina
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function caricaTimbratureAdmin() {
            const tbody = document.getElementById('tabellaTimbrature');
            tbody.innerHTML = '';
            
            timbrature.forEach(timbratura => {
                const dipendente = dipendenti.find(d => d.id === timbratura.dipendenteId);
                const oreLavorate = calcolaOreLavorate(timbratura.entrata, timbratura.uscita);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dipendente ? dipendente.nome : 'N/A'}</td>
                    <td>${timbratura.data}</td>
                    <td>${timbratura.entrata || '-'}</td>
                    <td>${timbratura.uscita || '-'}</td>
                    <td>${oreLavorate}</td>
                    <td class="timbratura-actions">
                        <button class="btn-danger" onclick="eliminaTimbratura(${timbratura.id})">
                            <i class="fas fa-trash"></i> Elimina
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function caricaFiltriDipendenti() {
            const filtroDipendente = document.getElementById('filtroDipendente');
            filtroDipendente.innerHTML = '<option value="">Tutti i dipendenti</option>';
            
            dipendenti.forEach(dipendente => {
                const option = document.createElement('option');
                option.value = dipendente.id;
                option.textContent = dipendente.nome;
                filtroDipendente.appendChild(option);
            });
        }

        function caricaFiltriReport() {
            const reportDipendente = document.getElementById('reportDipendente');
            reportDipendente.innerHTML = '<option value="">Tutti i dipendenti</option>';
            
            dipendenti.forEach(dipendente => {
                const option = document.createElement('option');
                option.value = dipendente.id;
                option.textContent = dipendente.nome;
                reportDipendente.appendChild(option);
            });
            
            // Imposta il mese corrente come default
            const oggi = new Date();
            document.getElementById('reportMese').value = oggi.toISOString().substring(0, 7);
        }

        function filtraTimbrature() {
            const dipendenteId = document.getElementById('filtroDipendente').value;
            const data = document.getElementById('filtroData').value;
            
            let timbratureFiltrate = timbrature;
            
            if (dipendenteId) {
                timbratureFiltrate = timbratureFiltrate.filter(t => t.dipendenteId == dipendenteId);
            }
            
            if (data) {
                timbratureFiltrate = timbratureFiltrate.filter(t => t.data === data);
            }
            
            const tbody = document.getElementById('tabellaTimbrature');
            tbody.innerHTML = '';
            
            timbratureFiltrate.forEach(timbratura => {
                const dipendente = dipendenti.find(d => d.id === timbratura.dipendenteId);
                const oreLavorate = calcolaOreLavorate(timbratura.entrata, timbratura.uscita);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dipendente ? dipendente.nome : 'N/A'}</td>
                    <td>${timbratura.data}</td>
                    <td>${timbratura.entrata || '-'}</td>
                    <td>${timbratura.uscita || '-'}</td>
                    <td>${oreLavorate}</td>
                    <td class="timbratura-actions">
                        <button class="btn-danger" onclick="eliminaTimbratura(${timbratura.id})">
                            <i class="fas fa-trash"></i> Elimina
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function generaReport() {
            const dipendenteId = document.getElementById('reportDipendente').value;
            const mese = document.getElementById('reportMese').value;
            
            let timbratureFiltrate = timbrature;
            
            if (dipendenteId) {
                timbratureFiltrate = timbratureFiltrate.filter(t => t.dipendenteId == dipendenteId);
            }
            
            if (mese) {
                timbratureFiltrate = timbratureFiltrate.filter(t => t.data.startsWith(mese));
            }
            
            // Calcola statistiche
            let oreTotali = 0;
            let giorniLavorati = 0;
            
            timbratureFiltrate.forEach(timbratura => {
                if (timbratura.entrata && timbratura.uscita) {
                    const oreDecimali = calcolaOreDecimali(timbratura.entrata, timbratura.uscita);
                    oreTotali += oreDecimali;
                    giorniLavorati++;
                }
            });
            
            const mediaOre = giorniLavorati > 0 ? (oreTotali / giorniLavorati).toFixed(2) : 0;
            
            // Aggiorna UI
            document.getElementById('reportOreTotali').textContent = oreTotali.toFixed(2);
            document.getElementById('reportGiorni').textContent = giorniLavorati;
            document.getElementById('reportMedia').textContent = mediaOre;
            
            // Dettaglio report
            const dettaglio = document.getElementById('reportDettaglio');
            dettaglio.innerHTML = `
                <h4 style="margin-bottom: 15px;">Dettaglio Timbrature</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Dipendente</th>
                            <th>Data</th>
                            <th>Entrata</th>
                            <th>Uscita</th>
                            <th>Ore Lavorate</th>
                            <th>Ore Decimali</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${timbratureFiltrate.map(timbratura => {
                            const dipendente = dipendenti.find(d => d.id === timbratura.dipendenteId);
                            const oreLavorate = calcolaOreLavorate(timbratura.entrata, timbratura.uscita);
                            const oreDecimali = calcolaOreDecimali(timbratura.entrata, timbratura.uscita);
                            return `
                                <tr>
                                    <td>${dipendente ? dipendente.nome : 'N/A'}</td>
                                    <td>${timbratura.data}</td>
                                    <td>${timbratura.entrata || '-'}</td>
                                    <td>${timbratura.uscita || '-'}</td>
                                    <td>${oreLavorate}</td>
                                    <td>${oreDecimali.toFixed(2)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function aggiungiDipendente() {
            const nome = document.getElementById('nuovoNome').value;
            const username = document.getElementById('nuovoUsername').value;
            const password = document.getElementById('nuovaPassword').value;
            
            if (!nome || !username || !password) {
                showNotification('❌ Compila tutti i campi!', 'error');
                return;
            }
            
            // Verifica se username già esiste
            if (dipendenti.some(d => d.username === username)) {
                showNotification('❌ Username già esistente!', 'error');
                return;
            }
            
            const nuovoId = dipendenti.length > 0 ? Math.max(...dipendenti.map(d => d.id)) + 1 : 1;
            const nuovoDipendente = {
                id: nuovoId,
                nome: nome,
                username: username,
                password: password
            };
            
            dipendenti.push(nuovoDipendente);
            caricaDipendentiAdmin();
            caricaDipendentiDashboard();
            caricaFiltriDipendenti();
            caricaFiltriReport();
            hideModal('modalAggiungiDipendente');
            showNotification('✅ Dipendente aggiunto con successo!', 'success');
            aggiornaStatisticheDashboard();
        }

        function modificaDipendente(id) {
            // Implementazione modifica dipendente
            showNotification('Funzionalità di modifica in sviluppo', 'info');
        }

        function eliminaDipendente(id) {
            if (confirm('Sei sicuro di voler eliminare questo dipendente?')) {
                dipendenti = dipendenti.filter(d => d.id !== id);
                // Rimuovi anche le timbrature associate
                timbrature = timbrature.filter(t => t.dipendenteId !== id);
                caricaDipendentiAdmin();
                caricaDipendentiDashboard();
                caricaFiltriDipendenti();
                caricaFiltriReport();
                showNotification('✅ Dipendente eliminato!', 'success');
                aggiornaStatisticheDashboard();
            }
        }

        function eliminaTimbratura(id) {
            if (confirm('Sei sicuro di voler eliminare questa timbratura?')) {
                timbrature = timbrature.filter(t => t.id !== id);
                caricaTimbratureAdmin();
                showNotification('✅ Timbratura eliminata!', 'success');
                aggiornaStatisticheDashboard();
            }
        }

        // BACKUP E RIPRISTINO
        function esportaDati(formato) {
            const data = {
                dipendenti: dipendenti,
                timbrature: timbrature,
                dataEsportazione: new Date().toISOString()
            };
            
            if (formato === 'excel') {
                // Crea un workbook con due fogli
                const wb = XLSX.utils.book_new();
                
                // Foglio dipendenti
                const wsDipendenti = XLSX.utils.json_to_sheet(dipendenti.map(d => ({
                    ID: d.id,
                    Nome: d.nome,
                    Username: d.username,
                    Password: d.password
                })));
                XLSX.utils.book_append_sheet(wb, wsDipendenti, "Dipendenti");
                
                // Foglio timbrature
                const wsTimbrature = XLSX.utils.json_to_sheet(timbrature.map(t => {
                    const dipendente = dipendenti.find(d => d.id === t.dipendenteId);
                    return {
                        ID: t.id,
                        Dipendente: dipendente ? dipendente.nome : 'N/A',
                        Data: t.data,
                        Entrata: t.entrata,
                        Uscita: t.uscita,
                        OreLavorate: calcolaOreLavorate(t.entrata, t.uscita),
                        OreDecimali: calcolaOreDecimali(t.entrata, t.uscita).toFixed(2)
                    };
                }));
                XLSX.utils.book_append_sheet(wb, wsTimbrature, "Timbrature");
                
                // Esporta
                XLSX.writeFile(wb, `backup_timbrature_${new Date().toISOString().split('T')[0]}.xlsx`);
                showNotification('✅ Backup Excel esportato!', 'success');
            } else if (formato === 'json') {
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_timbrature_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('✅ Backup JSON esportato!', 'success');
            }
        }

        function ripristinaDati() {
            const fileInput = document.getElementById('fileBackup');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('❌ Seleziona un file di backup!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.dipendenti && data.timbrature) {
                        if (confirm('ATTENZIONE: Questo sovrascriverà tutti i dati attuali. Continuare?')) {
                            dipendenti = data.dipendenti;
                            timbrature = data.timbrature;
                            
                            caricaDipendentiAdmin();
                            caricaDipendentiDashboard();
                            caricaTimbratureAdmin();
                            caricaFiltriDipendenti();
                            caricaFiltriReport();
                            aggiornaStatisticheDashboard();
                            
                            document.getElementById('backupStatus').className = 'backup-status backup-success';
                            document.getElementById('backupStatus').innerHTML = '<i class="fas fa-check-circle"></i> Dati ripristinati con successo!';
                            document.getElementById('backupStatus').style.display = 'block';
                            
                            showNotification('✅ Dati ripristinati con successo!', 'success');
                        }
                    } else {
                        document.getElementById('backupStatus').className = 'backup-status backup-error';
                        document.getElementById('backupStatus').innerHTML = '<i class="fas fa-exclamation-circle"></i> Formato file non valido!';
                        document.getElementById('backupStatus').style.display = 'block';
                    }
                } catch (error) {
                    document.getElementById('backupStatus').className = 'backup-status backup-error';
                    document.getElementById('backupStatus').innerHTML = '<i class="fas fa-exclamation-circle"></i> Errore durante il ripristino!';
                    document.getElementById('backupStatus').style.display = 'block';
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        // UTILITY
        function updateClock() {
            const now = new Date();
            document.getElementById('dashboardOrario').textContent = now.toLocaleTimeString('it-IT');
            document.getElementById('dashboardData').textContent = now.toLocaleDateString('it-IT', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function aggiornaStatisticheDashboard() {
            document.getElementById('totalDipendenti').textContent = dipendenti.length;
            
            const oggi = new Date().toISOString().split('T')[0];
            const timbratureOggi = timbrature.filter(t => t.data === oggi).length;
            document.getElementById('timbratureOggi').textContent = timbratureOggi;
            
            const dipendentiPresenti = new Set(timbrature
                .filter(t => t.data === oggi && t.entrata)
                .map(t => t.dipendenteId)
            ).size;
            document.getElementById('presentiOggi').textContent = dipendentiPresenti;
        }

        function calcolaOreLavorate(entrata, uscita) {
            if (!entrata || !uscita) return '-';
            
            const [h1, m1] = entrata.split(':').map(Number);
            const [h2, m2] = uscita.split(':').map(Number);
            
            let ore = h2 - h1;
            let minuti = m2 - m1;
            
            if (minuti < 0) {
                ore--;
                minuti += 60;
            }
            
            return `${ore.toString().padStart(2, '0')}:${minuti.toString().padStart(2, '0')}`;
        }

        function calcolaOreDecimali(entrata, uscita) {
            if (!entrata || !uscita) return 0;
            
            const [h1, m1] = entrata.split(':').map(Number);
            const [h2, m2] = uscita.split(':').map(Number);
            
            let ore = h2 - h1;
            let minuti = m2 - m1;
            
            if (minuti < 0) {
                ore--;
                minuti += 60;
            }
            
            return ore + (minuti / 60);
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>